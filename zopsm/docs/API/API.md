# Messaging API Documentation
Platform provides management and messaging interfaces for developers to develop easily
their own messaging application. Management Interface is for to manage SaaS features, such
as tenant subscriptions, applications and consumed services.


## REST API
Current Version's base url is `/api/v1`

## Messaging

### Common Features

There are some tokens and keys for authentication and multi tenant SaaS mechanisms:

|name                     | description                                        |
|-------------------------|----------------------------------------------------|
| `tenant_id`             | is to point SaaS account or sub-account            |
| `username`              | is to point end user of application, who is introduced and authenticated by `tenant`s backend server.|
| `app_id`                | is to identify the application of `tenant_id` |
| `service_token`         | is to identify the service which is being consumed by application `app_id` |


Almost all of the `Resources` have following methods and attributes:

|name                     | description                                            |
|-------------------------|--------------------------------------------------------|
| id                      | string, auto field, unique identifier of each record   |
|                         |  generated by database system                          | 
| creation_time           | timestamp, auto field, default now(), first creation time of record.|
| last_update_time        | timestamp, auto field, default now(), last update time of record.|
| is_deleted              | boolean, auto field, default false, indicates is record deleted or not |
| is_active               | boolean, auto field, default false, indicates is record deleted or not |

All `date` and `datetime` fields are kept in UTC format and it must be in GMT zone: `2017-08-20T08:54:56.750Z00:00`. 
Clients have to change local time zone info into GMT(+00:00).

`id` strings are generated by Riak internals automatically.

`bool` type fields are represented by json's `true` or `false`.

#### Method and Parameters

__Pagination__
Resources which allows listing and searching, can be fetched 20 item per page by default.
It is possible to tune pagination by parameters exemplified below:

`/api/v1/users/?page=1&page_size=10`

where `page` represents page number, while `page_size` represents page size. 

|name                    | description                                       |
|------------------------|---------------------------------------------------|
| `page`                 | current page number                               |
| `page_size`            | number of items per page (min 1, max 50)          |
| `next`                 | next page number                                  |
| `previous`             | previous page number                              |


__Sorting__

List and search results can be sorted by `ascending` or `descending`:

|name                    | description                                       |
|------------------------|---------------------------------------------------|
| `asc creation_time`    | sort                                |
| `desc creation_time`   | number of items per page                          |


`/api/v1/users/?page=1&page_size=10&asc=creation_time` lists users sorted by ascending
creation_time and 10 item per page, starting from page 1. 

#### Authentication and Authorization
Auth mechanism consists of three parts:

__End User Auth__:
End Users (consumer of a service via Applications) is authenticated by tenant's backend
server. The Platform does not keep end users' username and password. Authentication of
users must be done by tenant.

__Application Auth__:
Application sends username and password of user and its backend approves or denies user's
credentials. Backend server ask SaaS auth server for a `user_token` for an specific
service by providing `tenant_id`,  `service_token`, `user_id`, `app_id`. SaaS generates
an unique `user_token` for user.

All REST calls mush have this `user_token` in request headers.


#### Error Codes

* __200__: OK
* __202__: OK, request is queued
* __403__: Unauthorized
* __404__: Resource not found
* __409__: Conflict, resource is being changed by another process


#### API Reference
API Reference is available via `OPTIONS` method for each Resource. For example `Message`
resource reference is available via:

`curl -i -X OPTIONS https://api.zops.io/v1/message`


### Resources

#### User
[User](./User.md)

#### Subscriber
[Subscriber](./Subscriber.md)

#### Channel
[Channel](./Channel.md)

#### Message
[Message](./Message.md)


### List of Actions

| Done | Action                             | Resource       | Method    | URI                                                       | Params                         | Notes                                    |
|------|------------------------------------|----------------|-----------|-----------------------------------------------------------|--------------------------------|------------------------------------------|
| [x]  | Post message                       | Message        | Post      | /messages                                                 | None                           |                                          |
| [x]  | Delete message                     | Message        | Delete    | /messages/{message_id}                                    | None                           |                                          |
| [x]  | List message                       | Message        | Get       | /messages                                                 |                                |                                          |
| [x]  | Get message                        | Message        | Get       | /messages/{message_id}                                    | None                           |                                          |
| [x]  | Update message                     | Message        | Put       | /messages/{message_id}                                    | None                           |                                          |
| [x]  | Create channel                     | Channel        | Post      | /channels                                                 | None                           |                                          |
| [x]  | Delete channel                     | Channel        | Delete    | /channels/{channel_id}                                    | None                           |                                          |
| [x]  | Update channel                     | Channel        | Put       | /channels/{channel_id}                                    | None                           |                                          |
| [x]  | Get channel                        | Channel        | Get       | /channels/{channel_id}                                    | None                           |                                          |
| [x]  | List channel by type               | Channel        | Get       | /channels                                                 | `type`                         |                                          |
| [x]  | Subscribe a channel                | Subscriber     | Post      | /channels/{channel_id}/subscribers                        | None                           |                                          |
| [x]  | Unsubscribe a channel              | Subscriber     | Delete    | /channels/{channel_id}/subscribers/{subscriber_id}        | None                           | Subscriber or channel managers           |
| [x]  | Ban a subscriber from a channel    | BannedChannel  | Post      | /banned-channels                                          | None                           | `channel_id` and `subscriber_id` in body |
| [x]  | Unban a subscriber from a channel  | BannedChannel  | Delete    | /banned-channels/{channel_id}/subscribers/{subscriber_id} | None                           |                                          |
| [x]  | Ask / Invite to join               | Invite         | Post      | /invites                                                  | None                           | Subscriber asks, channel managers invite |
| [x]  | Approve or deny ask/invite request | Invite         | Put       | /invites/{invite_id}                                      | None                           | `approve` flag in body                   |   
| [x]  | Contact request                    | ContactRequest | Post      | /contact-requests                                         | None                           | `subscriber_id` in body                  |
| [x]  | Contact request approve            | ContactRequest | Put       | /contact-requests/{subscriber_id}                         | None                           | `approve` flag in body                   | 
| [x]  | Contact request list               | ContactRequest | Get       | /contact-requests                                         | None                           |                                          |
| [x]  | Contact get                        | Contact        | Get       | /contacts/{subscriber_id}                                 | None                           |                                          |
| [x]  | Contact delete                     | Contact        | Delete    | /contacts/{subscriber_id}                                 | None                           |                                          |
| [x]  | Ban contact                        | BannedContact  | Post      | /banned-contacts                                          | None                           | `subscriber_id` in body                  |
| [x]  | Unban contact                      | BannedContact  | Delete    | /banned-contacts/{subscriber_id}                          | None                           |                                          |
| [x]  | Status                             | Status         | Post      | /status                                                   | None                           |                                          |
| [x]  | Get Status                         | Status         | Get       | /status/{subscriber_id}                                   | None                           |                                          |
| [ ]  | Get Subscriber Information         | Me             | Get       | /me                                                       | None                           |                                          |


### SaaS Management

Management Entity Relation Diagram

```
        /----- Tenant ZOPSM(Tenant Managers) -----\
       /                 |                         \
  Account1 (Account Man)                 Account2 (Account Man)
   /     |         |     \                 /     |       |     \     
  /      |         |      \               /      |       |      \    
Users   Projects  Devs  Consumers       User   Project  Devs  Consumers
         /   \                                  /   \        
        /     \                                /     \       
   Service  Service                       Service   Service 
                                                           
```

Ayni servisten birden cok eklemek?


#### Consumers
Consumers is a set of unique users which can be divided into subsets
inside projects. A consumer is a unique entity for SaaS platform and
accounts. It can be bounded multiple projects as a consumer of enabled
services.

__Attributes__:

| attr           | description                               |
| -------------- | ----------------------------------------- |
| tenant_user_id | unique identifier of `tenant`'s user.     |
| tenant_id      | of which tenant user belongs to.          |
| tags           | list of user tags.                        |


#### Clients
A client is a unique device or application used by service consumers.

#### Users
Users are operational actors having predefined roles by SaaS, such as
developer, billing and admin.

#### Roles of Account
##### Developers:
Developer is main actor to create projects, attach services and
consumers, generating api tokens etc. Developer is invited by account
admin and can be authorized for one or more projects. Developer has full
control on authorized projects, but destroying them.

##### Billing

##### Admin

#### Roles of SaaS

| Role                | Description                                    |
|---------------------|------------------------------------------------|
| tenant_manager      | tenant operator                                |
| account_admin       | account general admin                          |
| account_developer   | account project operator                       |
| account_billing     | account billing operator                       |
| anonymous           | anonymous visitors                             |


##### Account Admin

##### Billing

#### Services
Service is defined by SaaS platform and can be attached projects.


#### Tenant Organization (Reseller)
Tenant is the owner entity of accounts and any others hierarchically. It
can create isolated accounts and set service limits for them.
 
#### Account Organization (Costumer)
Account is an umbrella entity for projects, users (service consumers) and
developers. Account managers can create projects, assign developers for
created projects and define a subset of its users to consume services under
projects. As shown in relation diagram users and developers are entities
can be assigned / to be allowed to consume services under projects.

#### Project
Project is defined by account managers under accounts. Services are
attached to project.


#### Service Consumers
Matching model for `tenant`'s users who can consume services.


#### Service

#### Project Token
Project Token is a JWT token which is valid for developer role operations. It has no an expire time and must be
protected securely by account users. It contains project_id.

#### User
Users can log in and operate SaaS services. They can CRUD services, projects,
consumers, accounts depending on their roles.


### List of Actions
| Done | Action                           | Resource            | Method | URI                                           | Params        | Role                             | Notes                                    |
|------|----------------------------------|---------------------|--------|-----------------------------------------------|---------------|----------------------------------|------------------------------------------|
| [~]  | Create Tenant                    | Tenant              | Post   | /tenant                                       | None          | tenant_manager                   |                                          |
| [ ]  | Delete Tenant                    | Tenant              | Delete | /tenant/{tenant_id}                           | None          | tenant_manager                   |                                          |
| [~]  | Update Tenant                    | Tenant              | Put    | /tenant/{tenant_id}                           | None          | tenant_manager                   |                                          |
| [~]  | Get Tenant                       | Tenant              | Get    | /tenant/{tenant_id}                           | None          | tenant_manager                   |                                          |
| [X]  | Register New Account             | Register            | Post   | /register                                     | None          | anonymous                        |                                          |
| [X]  | Approve Registration             | Register            | Put    | /register/{registration_id}                   | approve_code  | anonymous                        |                                          |
| [X]  | Create Acc. Admin                | Admin               | Post   | /admin                                        | None          | account_admin                    |                                          |
| [ ]  | Delete Acc. Admin                | AdminSingle         | Delete | /admin/{user_id}                              | None          | account_admin                    |                                          |
| [X]  | Update Acc. Admin                | AdminSingle         | Put    | /admin/{user_id}                              | None          | account_admin                    |                                          |
| [X]  | Get Acc. Admin                   | AdminSingle         | Get    | /admin/{user_id}                              | None          | account_admin                    |                                          |
| [X]  | List Acc. Admin                  | Admin               | Get    | /admin                                        | None          | account_admin                    |                                          |
| [X]  | Create Acc. Billing              | Billing             | Post   | /billing                                      | None          | account_admin                    |                                          |
| [ ]  | Delete Acc. Billing              | BillingSingle       | Delete | /billing/{user_id}                            | None          | account_admin                    |                                          |
| [X]  | Update Acc. Billing              | BillingSingle       | Put    | /billing/{user_id}                            | None          | account_admin, account_billing   |                                          |
| [X]  | Get Acc. Billing                 | BillingSingle       | Get    | /billing/{user_id}                            | None          | account_admin, account_billing   |                                          |
| [X]  | List Acc. Billing                | Billing             | Get    | /billing                                      | None          | account_admin                    |                                          |
| [X]  | Create Acc. Developer            | Developer           | Post   | /developer                                    | None          | account_admin                    |                                          |
| [ ]  | Delete Acc. Developer            | DeveloperSingle     | Delete | /developer/{user_id}                          | None          | account_admin                    |                                          |
| [X]  | Update Acc. Developer            | DeveloperSingle     | Put    | /developer/{user_id}                          | None          | account_admin, account_developer |                                          |
| [X]  | Get Acc. Developer               | DeveloperSingle     | Get    | /developer/{user_id}                          | None          | account_admin, account_developer |                                          |
| [X]  | List Acc. Developer              | Developer           | Get    | /developer                                    | None          | account_admin                    |                                          |
| [X]  | Create Project                   | Project             | Post   | /project                                      | None          | account_admin, account_developer |                                          |
| [X]  | Update Project                   | ProjectSingle       | Put    | /project/{project_id}                         | None          | account_admin, account_developer |                                          |
| [ ]  | Delete Project                   | ProjectSingle       | Delete | /project/{project_id}                         | None          | account_admin, account_developer |                                          |
| [X]  | Get Project                      | ProjectSingle       | Get    | /project/{project_id}                         | None          | account_admin, account_developer |                                          |
| [X]  | List Project                     | Project             | Get    | /project                                      | None          | account_admin, account_developer |                                          |
| [X]  | Refresh Project Token            | ProjectToken        | Put    | /project/{project_id}/token                   | None          | anonymous                        |                                          |
| [X]  | Services (can be bought)         | ServiceCatalog      | Get    | /services                                     | None          | anonymous                        |                                          |
| [X]  | Attach New Service               | Service             | Post   | /projects/{project_id}/service/               | None          | account_admin, account_developer |                                          |
| [X]  | Deattach Existing Service        | ServiceSingle       | Delete | /projects/{project_id}/service/{service_code}   | None          | account_admin, account_developer |                                          |
| [ ]  | Register App. Push Service       | ServiceSingle       | Put    | /projects/{project_id}/service/{service_id}   | None          | account_admin, account_developer |                                          |
| [X]  | Create Consumer                  | Consumer            | Post   | /consumer                                     | None          | account_admin, account_developer |                                          |
| [ ]  | Delete Consumer                  | Consumer            | Delete | /consumer/{consumer_id}                       | None          | account_admin, account_developer |                                          |
| [X]  | Update Consumer                  | Consumer            | Put    | /consumer/{consumer_id}                       | None          | account_admin, account_developer |                                          |
| [X]  | Get Consumer                     | Consumer            | Get    | /consumer/{consumer_id}                       | None          | account_admin, account_developer |                                          |
| [X]  | List Consumer                    | Consumer            | Get    | /consumer                                     | None          | account_admin, account_developer |                                          |
| [X]  | Attach Consumer                  | ProjectConsumer     | Post   | /projects/{project_id}/consumer/{consumer_id} | None          | account_admin, account_developer |                                          |
| [X]  | Deattach Consumer                | ProjectConsumer     | Delete | /projects/{project_id}/consumer/{consumer_id} | None          | account_admin, account_developer |                                          |
| [~]  | Bulk Attach Consumer             | ProjectConsumerBulk | Put    | /projects/{project_id}/consumer               | None          | account_admin, account_developer |                                          |
| [~]  | Bulk Deattach Consumer           | ProjectConsumerBulk | Delete | /projects/{project_id}/consumer               | None          | account_admin, account_developer 
| [X]  | Create Service Consumer Token    | ConsumerToken       | Post   | /projects/{project_id}/consumers/{consumer_id}/services/{service_code} | None    | account_admin, account_developer |                                          |
| [X]  | Invalidate Service Consumer Token| ConsumerToken       | Delete | /projects/{project_id}/consumers/{consumer_id}/services/{service_code}/tokens/{token} | None    | account_admin, account_developer |                                          |




## E2E Test

E2E tests runs in order specified below. Each action is related one or more API endpoint. 

### Registration

- Register New Account
- Approve Registration

New account and its primary admin created and approved.
 

### Account Actions

The admin creates, updates and deletes another admins and developers


- Create a new account admin
- List account admins
- Get the newly created account admin
- Update the newly created account admin
- Delete the newly created account admin

- Create a developer
- List developers
- Get the developer
- Update the developer
- Delete the developer
- Create a new super developer

### Project Actions

These steps runs twice for roles both admin and developer.

- Create a new project
- List projects
- Get project
- Update project
- Delete project

Developer creates a new project to work on and refresh its token.
- Create a new project
- Refresh project token

### Consumer Actions

- Create a consumer (runs 10 times)  bucket lists
- 


## Service Actions

- Attach messaging service
- 


trail projects?
log for developers


